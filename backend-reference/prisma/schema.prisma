// Prisma Schema - Estrutura do Banco de Dados
// Campos mapeados exatamente conforme a API Olé TV
// Para usar: npx prisma migrate dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// TABELAS DE INTEGRAÇÃO E AUTENTICAÇÃO
// ==========================================

model Integration {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  
  // Credenciais da API Olé
  oleKeyapi       String   @map("ole_keyapi")
  oleLogin        String   @map("ole_login")
  olePassword     String   @map("ole_password") // Criptografado
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  lastSync        DateTime? @map("last_sync")
  
  // Configurações
  webhookSecret   String?  @map("webhook_secret")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  syncQueue       SyncQueue[]
  syncLogs        SyncLog[]
  clientsCache    ClientCache[]
  oleClientes     OleCliente[]
  
  @@map("integrations")
}

// ==========================================
// FILA DE SINCRONIZAÇÃO
// ==========================================

enum SyncStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  CANCELLED
}

enum SyncAction {
  CREATE_CLIENT
  UPDATE_CLIENT
  REACTIVATE_CLIENT
  CREATE_CONTRACT
  UPDATE_CONTRACT
  CANCEL_CONTRACT
  CREATE_PRODUCT
  UPDATE_PRODUCT
  DELETE_PRODUCT
}

model SyncQueue {
  id              String     @id @default(uuid())
  integrationId   String     @map("integration_id")
  
  // Ação e dados
  action          SyncAction
  payload         Json       // Dados a serem enviados
  priority        Int        @default(0) // 0 = normal, 1+ = alta prioridade
  
  // Status e controle
  status          SyncStatus @default(PENDING)
  attempts        Int        @default(0)
  maxAttempts     Int        @default(3) @map("max_attempts")
  
  // Logs de erro
  errorLog        String?    @map("error_log") @db.Text
  lastError       String?    @map("last_error")
  
  // Timestamps
  scheduledFor    DateTime?  @map("scheduled_for")
  processedAt     DateTime?  @map("processed_at")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  
  // Relacionamento
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  @@index([status, scheduledFor])
  @@index([integrationId, status])
  @@map("sync_queue")
}

// ==========================================
// LOGS DE SINCRONIZAÇÃO (AUDITORIA)
// ==========================================

model SyncLog {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  
  // Detalhes da requisição
  endpoint        String
  method          String   @default("POST")
  requestBody     Json?    @map("request_body")
  
  // Resposta
  responseBody    Json?    @map("response_body")
  statusCode      Int?     @map("status_code")
  
  // Metadata
  duration        Int?     // em milissegundos
  success         Boolean  @default(false)
  errorMessage    String?  @map("error_message") @db.Text
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relacionamento
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  @@index([integrationId, createdAt])
  @@index([success, createdAt])
  @@map("sync_logs")
}

// ==========================================
// CACHE DE CLIENTES (DADOS LOCAIS DO WEBHOOK)
// ==========================================

enum ClientStatus {
  PENDING_VALIDATION    // Recém recebido do webhook, aguardando validação
  ENRICHED              // Dados complementares buscados
  VALIDATED             // Validado e mesclado
  PENDING_SYNC          // Na fila para sincronizar com OLÉ
  PENDING_REACTIVATION  // Na fila para reativar na OLÉ
  SYNCED                // Sincronizado com sucesso
  SYNC_FAILED           // Falha na sincronização
  ACTIVE                // Ativo na OLÉ
  INACTIVE              // Inativo na OLÉ
  CANCELLED             // Cancelado
}

model ClientCache {
  id              String       @id @default(uuid())
  integrationId   String       @map("integration_id")
  
  // Identificadores externos
  externalId      String       @map("external_id") // ID do sistema externo (webhook)
  oleClientId     String?      @map("ole_client_id") // ID na API Olé
  oleContractId   String?      @map("ole_contract_id")
  
  // Dados do cliente
  document        String       // CPF/CNPJ
  name            String
  email           String?
  phone           String?
  address         Json?        // Endereço completo
  
  // Dados do webhook original (para auditoria e reprocessamento)
  rawWebhookData  Json?        @map("raw_webhook_data")
  
  // Dados complementares (da API externa)
  complementaryData Json?      @map("complementary_data")
  
  // Validação e erros
  validationErrors Json?       @map("validation_errors")
  lastSyncError    String?     @map("last_sync_error") @db.Text
  lastSyncAt       DateTime?   @map("last_sync_at")
  
  // Status
  status          ClientStatus @default(PENDING_VALIDATION)
  syncedAt        DateTime?    @map("synced_at")
  
  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  
  // Relacionamento
  integration     Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  // Produtos do cliente
  products        ProductCache[]
  
  @@unique([integrationId, externalId])
  @@unique([integrationId, document])
  @@index([oleClientId])
  @@index([status])
  @@map("clients_cache")
}

// ==========================================
// CACHE DE PRODUTOS
// ==========================================

model ProductCache {
  id              String   @id @default(uuid())
  clientCacheId   String   @map("client_cache_id")
  
  // Identificadores
  externalId      String   @map("external_id")
  oleProductId    String?  @map("ole_product_id")
  
  // Dados do produto
  name            String
  code            String?
  price           Decimal? @db.Decimal(10, 2)
  quantity        Int      @default(1)
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  syncedAt        DateTime? @map("synced_at")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamento
  clientCache     ClientCache @relation(fields: [clientCacheId], references: [id], onDelete: Cascade)
  
  @@unique([clientCacheId, externalId])
  @@map("products_cache")
}

// ==========================================
// TOKENS E SESSÕES (API Externa)
// ==========================================

model ExternalApiToken {
  id              String   @id @default(uuid())
  integrationId   String   @unique @map("integration_id")
  
  // Token
  accessToken     String   @map("access_token") @db.Text
  tokenType       String   @default("Bearer") @map("token_type")
  expiresAt       DateTime @map("expires_at")
  
  // Metadata
  scope           String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("external_api_tokens")
}

// ==========================================
// DADOS SINCRONIZADOS DA OLÉ TV
// Campos mapeados EXATAMENTE como vem da API
// ==========================================

// ----------------
// CLIENTE OLÉTV
// Endpoint: POST /clientes/listar e /clientes/buscadados/{id}
// ----------------
model OleCliente {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  
  // ID na API Olé (campo "id" da resposta)
  oleId           String   @map("ole_id")
  
  // Dados básicos - conforme /clientes/listar
  nome            String
  cpfCnpj         String   @map("cpf_cnpj")  // Formato: 999.999.999-99
  dataNascimento  String?  @map("data_nascimento") // Formato: dd/mm/aaaa
  dataCadastro    String?  @map("data_cadastro")   // Formato: dd/mm/aaaa
  
  // Dados completos - conforme /clientes/buscadados/{id}
  tipoPessoa      String?  @map("tipo_pessoa")  // "Pessoa Física" ou "Pessoa Jurídica"
  nomeFantasia    String?  @map("nome_fantasia")
  inscricaoEstadual String? @map("inscricao_estadual")
  
  // Endereço (objeto "endereco" da API)
  enderecoLogradouro  String?  @map("endereco_logradouro")
  enderecoBairro      String?  @map("endereco_bairro")
  enderecoCidade      String?  @map("endereco_cidade")
  enderecoEstado      String?  @map("endereco_estado")  // estado_sigla
  enderecoNumero      String?  @map("endereco_numero")
  enderecoComplemento Json?    @map("endereco_complemento") // { tipo, valor }
  enderecoPontoReferencia String? @map("endereco_ponto_referencia")
  enderecoCep         String?  @map("endereco_cep")      // Formato: 99999-999
  
  // Contato
  contato         String?   // Campo "contato" da API
  telefones       Json?     // Array de { ddd, numero, ramal, tipo }
  emails          Json?     // Array de { email, tipo }
  
  // Vencimento e Status
  diaVencimento   String?  @map("dia_vencimento")  // "99"
  status          String   @default("Ativo")       // "Ativo", "Inativo", etc
  
  // Dados brutos completos da API (para auditoria)
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  contratos       OleContrato[]
  boletos         OleBoleto[]
  
  @@unique([integrationId, oleId])
  @@index([cpfCnpj])
  @@index([status])
  @@map("ole_clientes")
}

// ----------------
// CONTRATO OLÉTV
// Endpoint: POST /contratos/listar/{id_cliente}
// Relacionamento: Cliente → Contrato → Assinaturas → Equipamentos
// ----------------
model OleContrato {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  oleClienteId    String   @map("ole_cliente_local_id")
  
  // ID na API Olé (campo "id" da resposta)
  oleId           String   @map("ole_id")
  
  // Dados do contrato - conforme /contratos/listar/{id}
  codigo          String?  // "Código do contrato"
  tipo            String?  // "Principal", "Adicional"
  servico         String?  // "Olé TV"
  dataGeracao     String?  @map("data_geracao")   // dd/mm/aaaa
  dataAtivacao    String?  @map("data_ativacao")  // dd/mm/aaaa
  status          String   @default("Ativo")      // "Ativo (Sem Pendências)", etc
  
  // Dados brutos da API (backup)
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  cliente         OleCliente @relation(fields: [oleClienteId], references: [id], onDelete: Cascade)
  assinaturas     OleAssinatura[]
  
  @@unique([integrationId, oleId])
  @@index([status])
  @@map("ole_contratos")
}

// ----------------
// ASSINATURA OLÉTV
// Pertence a um Contrato
// ----------------
model OleAssinatura {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  oleContratoId   String   @map("ole_contrato_local_id")
  
  // ID na API Olé (campo "id" da assinatura)
  oleId           String   @map("ole_id")
  
  // Dados da assinatura - conforme /contratos/listar/{id}
  plano           String?  // "Plano A"
  box             String?  // "9" - quantidade de boxes
  dispositivos    String?  // "9" - quantidade de dispositivos
  statusAssinatura String? @map("status_assinatura")  // "Ativo"
  
  // Dados brutos (backup)
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamentos
  contrato        OleContrato @relation(fields: [oleContratoId], references: [id], onDelete: Cascade)
  equipamentos    OleEquipamentoContrato[]
  
  @@unique([integrationId, oleId])
  @@index([statusAssinatura])
  @@map("ole_assinaturas")
}

// ----------------
// EQUIPAMENTO DO CONTRATO OLÉTV
// Pertence a uma Assinatura
// (Diferente de OleEquipamento que é a lista de modelos disponíveis)
// ----------------
model OleEquipamentoContrato {
  id                String   @id @default(uuid())
  integrationId     String   @map("integration_id")
  oleAssinaturaId   String   @map("ole_assinatura_local_id")
  
  // ID na API Olé (campo "id" do equipamento)
  oleId             String   @map("ole_id")
  
  // Dados do equipamento - conforme /contratos/listar/{id}
  equipamento       String?  // "Nome Equipamento" - modelo do aparelho
  mac               String?  // "MAC do Equipamento"
  dataInicio        String?  @map("data_inicio")  // dd/mm/aaaa
  statusEquipamento String?  @map("status_equipamento")  // "Ativo"
  
  // Dados brutos (backup)
  rawData           Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt        DateTime @map("last_sync_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relacionamento
  assinatura        OleAssinatura @relation(fields: [oleAssinaturaId], references: [id], onDelete: Cascade)
  
  @@unique([integrationId, oleId])
  @@index([mac])
  @@index([statusEquipamento])
  @@map("ole_equipamentos_contrato")
}


// ----------------
// BOLETO OLÉTV
// Endpoint: POST /boletos/listar/{id_cliente}
// ----------------
model OleBoleto {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  oleClienteId    String   @map("ole_cliente_local_id")
  
  // ID na API Olé (campo "id" da resposta)
  oleId           String   @map("ole_id")
  
  // Dados do boleto - conforme /boletos/listar/{id}
  codigo          String?  // "99999999999"
  formato         String?  // "Boleto Online (SICOOB) [OTT]"
  
  // Referente - Array com período e itens
  // { periodo: "mes/ano", itens: [{ descricao, valor }] }
  referente       Json?    // Array de objetos referente
  
  // Datas - objeto com geracao, vencimento, pagamento
  dataGeracao     String?  @map("data_geracao")     // dd/mm/aaaa
  dataVencimento  String?  @map("data_vencimento")  // dd/mm/aaaa
  dataPagamento   String?  @map("data_pagamento")   // dd/mm/aaaa ou null
  
  // Valores - objeto com bonificacao e valor
  valorBonificacao String? @map("valor_bonificacao") // "R$ 9,99"
  valorTotal       String? @map("valor_total")       // "R$ 99,99"
  
  // Identificadores bancários
  nossoNumero     String?  @map("nosso_numero")     // "9999999"
  linhaDigitavel  String?  @map("linha_digitavel")  // "99999.99999 ..."
  
  // Status
  status          String   @default("Em Aberto")    // "Pago", "Em Aberto"
  
  // Dados brutos da API
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relacionamento
  cliente         OleCliente @relation(fields: [oleClienteId], references: [id], onDelete: Cascade)
  
  @@unique([integrationId, oleId])
  @@index([status])
  @@index([dataVencimento])
  @@map("ole_boletos")
}

// ----------------
// PLANOS OLÉTV (Cache)
// Endpoint: POST /planos
// ----------------
model OlePlano {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  
  // ID na API Olé
  oleId           String   @map("ole_id")
  
  // Dados do plano - conforme /planos
  tipo            String?  // "Principal", "Adicional"
  nome            String   // "Plano A"
  taxaInstalacao  String?  @map("taxa_instalacao")  // "999.00"
  
  // Mensalidades
  mensalidadeNormal       String?  @map("mensalidade_normal")        // "99.99"
  mensalidadeAteVencimento String? @map("mensalidade_ate_vencimento") // "99.99"
  mensalidadePromocao     String?  @map("mensalidade_promocao")      // "99.99"
  
  // Dados brutos
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([integrationId, oleId])
  @@map("ole_planos")
}

// ----------------
// EQUIPAMENTOS OLÉTV (Cache)
// Endpoint: POST /equipamentos
// ----------------
model OleEquipamento {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  
  // ID na API Olé
  oleId           String   @map("ole_id")
  
  // Dados do equipamento - conforme /equipamentos
  nome            String   // "Modelo A"
  
  // Dados brutos
  rawData         Json?    @map("raw_data")
  
  // Sincronização
  lastSyncAt      DateTime @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([integrationId, oleId])
  @@map("ole_equipamentos")
}

// ==========================================
// MAPEAMENTO DE PRODUTOS (IntegrationCode → Plano Olé)
// ==========================================

model ProductPlanMapping {
  id              String   @id @default(uuid())
  integrationId   String   @map("integration_id")
  
  // Código de integração (vem do webhook Services[].IntegrationCode)
  integrationCode String   @map("integration_code")  // Ex: "TV_BOX", "MOBILE", etc
  
  // ID do plano na Olé TV
  olePlanoId      String   @map("ole_plano_id")
  olePlanoNome    String?  @map("ole_plano_nome")     // Nome para referência
  
  // Prioridade (maior = mais importante)
  // Usado para decidir qual plano usar quando vêm múltiplos IntegrationCodes
  priority        Int      @default(0)
  
  // Tipo de plano
  isMainPlan      Boolean  @default(true) @map("is_main_plan")  // Principal ou adicional
  
  // Metadados
  description     String?  // Descrição do mapeamento
  isActive        Boolean  @default(true) @map("is_active")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([integrationId, integrationCode])
  @@index([integrationId, priority])
  @@map("product_plan_mappings")
}
